<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim Racing Keymap Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            background: linear-gradient(90deg, #ff4444, #ff8800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 20;
        }

        .panel-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #ff8800;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ– */
        .layer-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .layer-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .layer-tab.active {
            background: linear-gradient(135deg, #ff4444, #ff8800);
            color: #fff;
            font-weight: bold;
        }

        .layer-name {
            cursor: text;
            padding: 2px 5px;
            border-radius: 4px;
            min-width: 50px;
        }

        .layer-name:focus {
            background: rgba(0, 0, 0, 0.3);
            outline: none;
        }

        .layer-tab .delete-layer {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.5);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: normal;
            opacity: 0.7;
        }

        .layer-tab .delete-layer:hover {
            opacity: 1;
            background: rgba(255, 0, 0, 0.8);
        }

        .add-layer-btn {
            padding: 10px 20px;
            background: rgba(255, 136, 0, 0.2);
            border: 2px dashed #ff8800;
            border-radius: 8px;
            color: #ff8800;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-layer-btn:hover {
            background: rgba(255, 136, 0, 0.3);
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¨ãƒªã‚¢ */
        .layout-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            overflow: auto;
        }

        .layout-container {
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }

        #controllerImage {
            display: block;
            max-width: 100%;
            height: auto;
            user-select: none;
            pointer-events: none;
        }

        #controlBoxes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .control-box {
            position: absolute;
            background: rgba(255, 136, 0, 0.3);
            border: 2px solid #ff8800;
            border-radius: 6px;
            padding: 2px;
            color: #fff;
            font-size: 14px;
            text-align: center;
            cursor: move;
            transition: border-color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
            overflow: hidden;
            pointer-events: auto; /* é‡è¦ */
            user-select: none;
        }

        .resize-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #00ff88;
            border: 2px solid #1a1a2e;
            border-radius: 50%;
            z-index: 1001;
            box-sizing: border-box;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .layout-wrapper {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 10;
            width: 100%;
            display: flex;
            justify-content: center;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.3); /* Ensure consistency */
        }

        .editor-panel {
            position: relative;
            z-index: 20;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%);
            backdrop-filter: blur(10px);
        }

        /* ===== ã‚¿ãƒƒãƒæ“ä½œå¯¾å¿œ ===== */
        .control-box{
            touch-action: none;
        }

        .control-box.circle {
            border-radius: 50%;
        }

        .control-box.rectangle {
            border-radius: 6px;
        }

        .control-box:hover {
            border-color: #ffa500;
            box-shadow: 0 0 15px rgba(255, 136, 0, 0.5);
        }

        .control-box.selected {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
            z-index: 1000;
        }

        .control-box.copying {
            opacity: 0.5;
            border-style: dashed;
        }

        /* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ‘ãƒãƒ« */
        .editor-panel {
            display: none;
            width: 100%;
            box-sizing: border-box;
            clear: both;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .editor-panel.visible {
            display: grid;
        }

        .editor-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .editor-section h3 {
            color: #ff8800;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-family: monospace;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒœã‚¿ãƒ³ */
        .keycode-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .category-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .category-btn.active {
            background: linear-gradient(135deg, #ff4444, #ff8800);
            color: #000;
            font-weight: bold;
        }

        .keycode-quick {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .keycode-quick.visible {
            display: grid;
        }

        .keycode-btn {
            padding: 8px;
            background: rgba(255, 136, 0, 0.1);
            border: 1px solid rgba(255, 136, 0, 0.3);
            border-radius: 6px;
            color: #ff8800;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .keycode-btn:hover {
            background: rgba(255, 136, 0, 0.2);
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff4444, #ff8800);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 136, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-danger {
            background: rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .toolbar input[type="file"] {
            display: none;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #zoomLevel {
            color: #ff8800;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        /* ã‚¿ãƒ– */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: #ff8800;
        }

        .tab-btn.active {
            color: #ff8800;
            border-bottom-color: #ff8800;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .color-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-group label {
            font-size: 0.9em;
            color: #aaa;
        }

        .color-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input-wrapper input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .color-input-wrapper input[type="text"] {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-family: monospace;
        }

        .status {
            font-size: 0.85em;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .status.success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .status.error {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        /* Gistè¨­å®š */
        .gist-settings {
            display: grid;
            gap: 10px;
        }

        .gist-input {
            display: flex;
            gap: 10px;
        }

        .gist-input input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
        }

        /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        .color-palette {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            max-height: 70vh;
    overflow-y: auto;
    touch-action: auto;
    -webkit-overflow-scrolling: touch;
        }

        .palette-color {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .palette-color:hover {
            transform: scale(1.1);
            border-color: #ff8800;
        }

        .palette-add {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background: rgba(255, 136, 0, 0.2);
            border: 2px dashed rgba(255, 136, 0, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff8800;
            font-size: 20px;
            transition: all 0.2s;
        }

        .palette-add:hover {
            background: rgba(255, 136, 0, 0.3);
        }

        /* ç”»åƒé¸æŠ */
        .image-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .image-option {
            padding: 8px 16px;
            background: rgba(255, 136, 0, 0.1);
            border: 2px solid rgba(255, 136, 0, 0.3);
            border-radius: 6px;
            color: #ff8800;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .image-option:hover {
            background: rgba(255, 136, 0, 0.2);
            border-color: #ff8800;
        }
   .resize-handle {
    position: absolute;
    width: 24px;
    height: 24px;
    background: #00ff88;
    border-radius: 50%;
    border: 2px solid #000;
    touch-action: none;
    z-index: 2000;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸï¸ Sim Racing Keymap Editor</h1>

        <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† -->
        <div class="panel">
            <div class="panel-title">
                <div>ğŸ“‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
                <div style="font-size: 0.9em; color: #888;">
                    ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: <span id="layerCount" style="color: #ff8800; font-weight: bold; font-size: 1.1em;">0</span>
                </div>
            </div>
            <div class="layer-tabs" id="layerTabs">
                <button class="add-layer-btn" onclick="addLayer()">+ ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ </button>
            </div>
        </div>

        <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¨ãƒªã‚¢ -->
        <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¨ãƒªã‚¢ -->
        <div class="panel sticky-layout-panel">
            <div class="panel-title">ğŸ® ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>

            <div class="toolbar">
                <label for="imageUpload" class="btn btn-small">
                    ğŸ“· ç”»åƒã‚’èª­ã¿è¾¼ã‚€
                </label>
                <input type="file" id="imageUpload" accept="image/*" onchange="loadImage(event)">

                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
                    <span id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                </div>

                <button class="btn btn-small" onclick="addControlBox()">+ ãƒœã‚¿ãƒ³è¿½åŠ </button>
                <button class="btn btn-small btn-secondary" onclick="deleteSelectedBox()">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>

            <div class="image-select" id="imageSelect" style="display: none;">
                <div style="width: 100%; color: #aaa; font-size: 0.9em;">åŒã˜éšå±¤ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«:</div>
            </div>
        </div>

        <!-- Sticky Image Wrapper -->
        <div class="layout-wrapper">
                <div class="layout-container" id="layoutContainer">
                    <img id="controllerImage" src="" alt="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„" style="display: none;">
                    <div id="controlBoxes"></div>
                </div>


        </div>

        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
        <div class="panel editor-panel" id="editorPanel">
            <div class="editor-section">
                <h3>ğŸ”§ ãƒœã‚¿ãƒ³è¨­å®š <span id="selectedBoxId" style="font-size: 0.9em; color: #aaa;"></span></h3>

                <div class="input-group">
                    <label>ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰:</label>
                    <input type="text" id="keycodeInput" placeholder="ä¾‹: A" oninput="updateKeycode(this.value)">
                </div>

                <div class="input-group">
                    <label>ä½ç½®ã¨ã‚µã‚¤ã‚º:</label>
                    <div class="input-row">
                        <div>
                            <label style="font-size: 0.8em;">Xä½ç½® (px)</label>
                            <input type="number" id="boxX" oninput="updateBoxPosition()">
                        </div>
                        <div>
                            <label style="font-size: 0.8em;">Yä½ç½® (px)</label>
                            <input type="number" id="boxY" oninput="updateBoxPosition()">
                        </div>
                    </div>
                    <div class="input-row" style="margin-top: 8px;">
                        <div>
                            <label style="font-size: 0.8em;">å¹… (px)</label>
                            <input type="number" id="boxWidth" oninput="updateBoxSize()">
                        </div>
                        <div>
                            <label style="font-size: 0.8em;">é«˜ã• (px)</label>
                            <input type="number" id="boxHeight" oninput="updateBoxSize()">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>å½¢çŠ¶:</label>
                    <select id="boxShape" onchange="updateBoxStyle()">
                        <option value="rectangle">å››è§’</option>
                        <option value="circle">ä¸¸</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>ãƒ•ã‚©ãƒ³ãƒˆ:</label>
                    <select id="boxFont" onchange="updateBoxStyle()">
                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                        <option value="'Meiryo', sans-serif">ãƒ¡ã‚¤ãƒªã‚ª (Meiryo)</option>
                        <option value="'MS PGothic', 'MS Gothic', sans-serif">ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="'Yu Gothic', sans-serif">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="'Consolas', monospace">Consolas</option>
                        <option value="'SF Mono', monospace">SF Mono</option>
                        <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (px):</label>
                    <input type="number" id="boxFontSize" value="14" min="1" oninput="updateBoxStyle()">
                </div>



                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 136, 0, 0.1); border-radius: 6px; font-size: 0.85em;">
                    <strong>æ“ä½œæ–¹æ³•:</strong><br>
                    â€¢ ãƒ‰ãƒ©ãƒƒã‚°ã§ä½ç½®ç§»å‹•<br>
                    â€¢ â† â†’ â†‘ â†“ ã§1pxç§»å‹•<br>
                    â€¢ Shift + çŸ¢å°ã§ã‚µã‚¤ã‚ºèª¿æ•´<br>
                    â€¢ Ctrl + ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚³ãƒ”ãƒ¼
                </div>
            </div>

            <div class="editor-section">
                <h3>ğŸ¨ ã‚«ãƒ©ãƒ¼è¨­å®š</h3>
                <div class="input-group">
                    <label>ãƒœãƒƒã‚¯ã‚¹ã‚«ãƒ©ãƒ¼:</label>
                    <div class="color-grid">
                        <div class="color-group">
                            <label>èƒŒæ™¯è‰²</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="boxBgColor" value="#ff8800" oninput="updateBoxColor()">
                                <input type="text" id="boxBgColorText" value="#ff8800" oninput="updateBoxColorFromText('bg')">
                            </div>
                            <div class="color-palette" id="bgColorPalette"></div>
                        </div>
                        <div class="color-group">
                            <label>ãƒ†ã‚­ã‚¹ãƒˆè‰²</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="boxTextColor" value="#ffffff" oninput="updateBoxColor()">
                                <input type="text" id="boxTextColorText" value="#ffffff" oninput="updateBoxColorFromText('text')">
                            </div>
                            <div class="color-palette" id="textColorPalette"></div>
                        </div>
                        <div class="color-group">
                            <label>ãƒœãƒ¼ãƒ€ãƒ¼è‰²</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="boxBorderColor" value="#ff8800" oninput="updateBoxColor()">
                                <input type="text" id="boxBorderColorText" value="#ff8800" oninput="updateBoxColorFromText('border')">
                            </div>
                            <div class="color-palette" id="borderColorPalette"></div>
                        </div>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

                <h3>âŒ¨ï¸ ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰é¸æŠ</h3>

                <div class="keycode-categories">
                    <button class="category-btn active" onclick="showCategory('basic')">åŸºæœ¬</button>
                    <button class="category-btn" onclick="showCategory('mod')">ä¿®é£¾</button>
                    <button class="category-btn" onclick="showCategory('layer')">ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
                    <button class="category-btn" onclick="showCategory('media')">ãƒ¡ãƒ‡ã‚£ã‚¢</button>
                    <button class="category-btn" onclick="showCategory('function')">ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³</button>
                    <button class="category-btn" onclick="showCategory('racing')">ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°</button>
                    <button class="category-btn" onclick="showCategory('special')">ç‰¹æ®Š</button>
                </div>

                <!-- åŸºæœ¬ã‚­ãƒ¼ -->
                <div class="keycode-quick visible" id="basicKeycodes">
                    <button class="keycode-btn" data-kc="A">A</button>
                    <button class="keycode-btn" data-kc="B">B</button>
                    <button class="keycode-btn" data-kc="C">C</button>
                    <button class="keycode-btn" data-kc="D">D</button>
                    <button class="keycode-btn" data-kc="E">E</button>
                    <button class="keycode-btn" data-kc="F">F</button>
                    <button class="keycode-btn" data-kc="G">G</button>
                    <button class="keycode-btn" data-kc="H">H</button>
                    <button class="keycode-btn" data-kc="I">I</button>
                    <button class="keycode-btn" data-kc="J">J</button>
                    <button class="keycode-btn" data-kc="K">K</button>
                    <button class="keycode-btn" data-kc="L">L</button>
                    <button class="keycode-btn" data-kc="M">M</button>
                    <button class="keycode-btn" data-kc="N">N</button>
                    <button class="keycode-btn" data-kc="O">O</button>
                    <button class="keycode-btn" data-kc="P">P</button>
                    <button class="keycode-btn" data-kc="Q">Q</button>
                    <button class="keycode-btn" data-kc="R">R</button>
                    <button class="keycode-btn" data-kc="S">S</button>
                    <button class="keycode-btn" data-kc="T">T</button>
                    <button class="keycode-btn" data-kc="U">U</button>
                    <button class="keycode-btn" data-kc="V">V</button>
                    <button class="keycode-btn" data-kc="W">W</button>
                    <button class="keycode-btn" data-kc="X">X</button>
                    <button class="keycode-btn" data-kc="Y">Y</button>
                    <button class="keycode-btn" data-kc="Z">Z</button>
                    <button class="keycode-btn" data-kc="0">0</button>
                    <button class="keycode-btn" data-kc="1">1</button>
                    <button class="keycode-btn" data-kc="2">2</button>
                    <button class="keycode-btn" data-kc="3">3</button>
                    <button class="keycode-btn" data-kc="4">4</button>
                    <button class="keycode-btn" data-kc="5">5</button>
                    <button class="keycode-btn" data-kc="6">6</button>
                    <button class="keycode-btn" data-kc="7">7</button>
                    <button class="keycode-btn" data-kc="8">8</button>
                    <button class="keycode-btn" data-kc="9">9</button>
                    <button class="keycode-btn" data-kc="Space">Space</button>
                    <button class="keycode-btn" data-kc="Enter">Enter</button>
                    <button class="keycode-btn" data-kc="Esc">Esc</button>
                    <button class="keycode-btn" data-kc="Tab">Tab</button>
                </div>

                <!-- ä¿®é£¾ã‚­ãƒ¼ -->
                <div class="keycode-quick" id="modKeycodes">
                    <button class="keycode-btn" data-kc="LShift">L Shift</button>
                    <button class="keycode-btn" data-kc="RShift">R Shift</button>
                    <button class="keycode-btn" data-kc="LCtrl">L Ctrl</button>
                    <button class="keycode-btn" data-kc="RCtrl">R Ctrl</button>
                    <button class="keycode-btn" data-kc="LAlt">L Alt</button>
                    <button class="keycode-btn" data-kc="RAlt">R Alt</button>
                    <button class="keycode-btn" data-kc="LWin">L Win</button>
                    <button class="keycode-btn" data-kc="RWin">R Win</button>
                    <button class="keycode-btn" data-kc="Ctrl+A">Ctrl+A</button>
                    <button class="keycode-btn" data-kc="Ctrl+C">Ctrl+C</button>
                    <button class="keycode-btn" data-kc="Ctrl+V">Ctrl+V</button>
                    <button class="keycode-btn" data-kc="Ctrl+Z">Ctrl+Z</button>
                    <button class="keycode-btn" data-kc="Shift+A">Shift+A</button>
                    <button class="keycode-btn" data-kc="Alt+F4">Alt+F4</button>
                </div>

                <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
                <div class="keycode-quick" id="layerKeycodes">
                    <button class="keycode-btn" data-kc="Layer0">Layer 0</button>
                    <button class="keycode-btn" data-kc="Layer1">Layer 1</button>
                    <button class="keycode-btn" data-kc="Layer2">Layer 2</button>
                    <button class="keycode-btn" data-kc="Layer3">Layer 3</button>
                    <button class="keycode-btn" data-kc="NextLayer">Next Layer</button>
                    <button class="keycode-btn" data-kc="PrevLayer">Prev Layer</button>
                </div>

                <!-- ãƒ¡ãƒ‡ã‚£ã‚¢ã‚­ãƒ¼ -->
                <div class="keycode-quick" id="mediaKeycodes">
                    <button class="keycode-btn" data-kc="Mute">ğŸ”‡ Mute</button>
                    <button class="keycode-btn" data-kc="Vol+">ğŸ”Š Vol+</button>
                    <button class="keycode-btn" data-kc="Vol-">ğŸ”‰ Vol-</button>
                    <button class="keycode-btn" data-kc="Play">â–¶ Play</button>
                    <button class="keycode-btn" data-kc="Stop">â¹ Stop</button>
                    <button class="keycode-btn" data-kc="Prev">â® Prev</button>
                    <button class="keycode-btn" data-kc="Next">â­ Next</button>
                </div>

                <!-- ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ -->
                <div class="keycode-quick" id="functionKeycodes">
                    <button class="keycode-btn" data-kc="F1">F1</button>
                    <button class="keycode-btn" data-kc="F2">F2</button>
                    <button class="keycode-btn" data-kc="F3">F3</button>
                    <button class="keycode-btn" data-kc="F4">F4</button>
                    <button class="keycode-btn" data-kc="F5">F5</button>
                    <button class="keycode-btn" data-kc="F6">F6</button>
                    <button class="keycode-btn" data-kc="F7">F7</button>
                    <button class="keycode-btn" data-kc="F8">F8</button>
                    <button class="keycode-btn" data-kc="F9">F9</button>
                    <button class="keycode-btn" data-kc="F10">F10</button>
                    <button class="keycode-btn" data-kc="F11">F11</button>
                    <button class="keycode-btn" data-kc="F12">F12</button>
                    <button class="keycode-btn" data-kc="Home">Home</button>
                    <button class="keycode-btn" data-kc="End">End</button>
                    <button class="keycode-btn" data-kc="PgUp">PgUp</button>
                    <button class="keycode-btn" data-kc="PgDn">PgDn</button>
                    <button class="keycode-btn" data-kc="â†‘">â†‘</button>
                    <button class="keycode-btn" data-kc="â†“">â†“</button>
                    <button class="keycode-btn" data-kc="â†">â†</button>
                    <button class="keycode-btn" data-kc="â†’">â†’</button>
                </div>

                <!-- ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å°‚ç”¨ -->
                <div class="keycode-quick" id="racingKeycodes">
                    <button class="keycode-btn" data-kc="ABS+">ABS +</button>
                    <button class="keycode-btn" data-kc="ABS-">ABS -</button>
                    <button class="keycode-btn" data-kc="TC+">TC +</button>
                    <button class="keycode-btn" data-kc="TC-">TC -</button>
                    <button class="keycode-btn" data-kc="BB+">BB +</button>
                    <button class="keycode-btn" data-kc="BB-">BB -</button>
                    <button class="keycode-btn" data-kc="ENG+">ENG +</button>
                    <button class="keycode-btn" data-kc="ENG-">ENG -</button>
                    <button class="keycode-btn" data-kc="FUEL+">FUEL +</button>
                    <button class="keycode-btn" data-kc="FUEL-">FUEL -</button>
                    <button class="keycode-btn" data-kc="DRS">DRS</button>
                    <button class="keycode-btn" data-kc="PIT">PIT</button>
                    <button class="keycode-btn" data-kc="RADIO">RADIO</button>
                    <button class="keycode-btn" data-kc="LIGHTS">LIGHTS</button>
                    <button class="keycode-btn" data-kc="WIPER">WIPER</button>
                    <button class="keycode-btn" data-kc="CAM">CAM</button>
                    <button class="keycode-btn" data-kc="LOOK_L">LOOK L</button>
                    <button class="keycode-btn" data-kc="LOOK_R">LOOK R</button>
                    <button class="keycode-btn" data-kc="LOOK_B">LOOK B</button>
                    <button class="keycode-btn" data-kc="MAP">MAP</button>
                </div>

                <!-- ç‰¹æ®Š -->
                <div class="keycode-quick" id="specialKeycodes">
                    <button class="keycode-btn" data-kc="Del">Del</button>
                    <button class="keycode-btn" data-kc="Ins">Ins</button>
                    <button class="keycode-btn" data-kc="Backspace">BkSp</button>
                    <button class="keycode-btn" data-kc="PrtSc">PrtSc</button>
                    <button class="keycode-btn" data-kc="-">-</button>
                    <button class="keycode-btn" data-kc="=">=</button>
                    <button class="keycode-btn" data-kc="[">[</button>
                    <button class="keycode-btn" data-kc="]">]</button>
                    <button class="keycode-btn" data-kc=";">;</button>
                    <button class="keycode-btn" data-kc="'">'</button>
                    <button class="keycode-btn" data-kc=",">,</button>
                    <button class="keycode-btn" data-kc=".">.</button>
                    <button class="keycode-btn" data-kc="/">/</button>
                    <button class="keycode-btn" data-kc="\\">\</button>
                    <button class="keycode-btn" data-kc="`">`</button>
                </div>
            </div>
        </div>

        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="panel">
            <div class="panel-title">ğŸ’¾ ä¿å­˜ / èª­è¾¼ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>

            <div style="margin-bottom: 20px;">
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 180, 219, 0.1); border-left: 3px solid #00b4db; border-radius: 4px; font-size: 0.9em;">
                    <strong>å…¨ç«¯æœ«å…±é€šã‚µãƒ¼ãƒãƒ¼ä¿å­˜</strong><br>
                    é¸æŠã—ãŸã‚¹ãƒ­ãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰(Google Cloud Storage)ã«ä¿å­˜ã•ã‚Œã€iPhone/PCã©ã¡ã‚‰ã‹ã‚‰ã§ã‚‚åŒã˜çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚ã¾ã™ã€‚
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em;">
                        ä¿å­˜ã‚¹ãƒ­ãƒƒãƒˆé¸æŠ:
                    </label>
                    <select id="cloudSlot" style="width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 8px; color: #fff;">
                        <option value="slot1">PXN_CB1</option>
                        <option value="slot2">GTNeo</option>
                        <option value="slot3">Slot 3 </option>
                        <option value="slot4">Slot 4 </option>
                        <option value="slot5">Slot 5 </option>
                    </select>
                </div>
                <div class="actions">
                    <button class="btn" style="background: linear-gradient(135deg, #00b4db, #0083b0);" onclick="cloudSave()">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="cloudLoad()">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­è¾¼</button>
                    <button class="btn btn-secondary" onclick="exportAsImage()">ğŸ–¼ï¸ ç”»åƒã¨ã—ã¦ä¿å­˜ (.png)</button>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

            <div>
                <h4 style="color: #ff8800; margin-bottom: 10px;">ãã®ä»–</h4>
                <div class="actions">
                    <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== RESPONSIVE COORDINATE HELPERS ====================
        // ç”»é¢ä¸Šã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™(event.clientXYç­‰)ã‹ã‚‰ã€ç”»åƒå†…ã®ã€Œæ­£è¦åŒ–åº§æ¨™(%)ã€ã‚’è¨ˆç®—ã™ã‚‹
        function getRelativePos(clientX, clientY) {
            const img = document.getElementById('controllerImage');
            const rect = img.getBoundingClientRect();
            // ç”»åƒå†…ã§ã®ãƒ”ã‚¯ã‚»ãƒ«ä½ç½®
            let px = (clientX - rect.left);
            let py = (clientY - rect.top);

            // 0~100%ã«å¤‰æ› (ç”»åƒã®è¡¨ç¤ºã‚µã‚¤ã‚ºã«åŸºã¥ã)
            let xPct = (px / rect.width) * 100;
            let yPct = (py / rect.height) * 100;

            // ç¯„å›²åˆ¶é™
            // xPct = Math.max(0, Math.min(100, xPct));
            // yPct = Math.max(0, Math.min(100, yPct));

            return { xPct, yPct };
        }

        // ==================== CONTROL BOX MANAGEMENT (RESPONSIVE) ====================
        function addControlBox() {
            // åˆæœŸä½ç½®ä¸­å¤®
            const box = {
                id: nextBoxId++,
                xPct: 50, yPct: 50, // %ã§ä¿æŒ
                widthPct: 10, heightPct: 6, // ã‚µã‚¤ã‚ºã‚‚%ã§ä¿æŒæ¨å¥¨ã ãŒã€ã¾ãšã¯ä½ç½®ä¿®æ­£ã«æ³¨åŠ›
                // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¸€æ—¦pixelå€¤ã‚‚æŒãŸã›ã‚‹ãŒã€renderæ™‚ã¯ç„¡è¦–ã™ã‚‹æ–¹é‡
                width: 80, height: 50,
                fontSize: 14,
                shape: 'rectangle', bgColor: '#ff8800', textColor: '#ffffff',
                borderColor: '#ff8800', fontFamily: "'Segoe UI', sans-serif"
            };
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›(åˆå›ã®äººã®ãŸã‚)
            if(!box.xPct) box.xPct = 10;

            controlBoxes.push(box);
            layers.forEach(layer => { layer.boxes[box.id] = ''; });
            renderControlBoxes();
            selectBox(box.id);
        }

        function renderControlBoxes() {
            const container = document.getElementById('controlBoxes');
            const img = document.getElementById('controllerImage');
            container.innerHTML = '';

            if (img.style.display === 'none' || img.clientWidth === 0) return;

            const currentLayerData = layers[currentLayer];
            if (!currentLayerData) return;

            const currentImgW = img.clientWidth;
            const currentImgH = img.clientHeight;
            const responsiveScale = currentImgW / 1000;

            controlBoxes.forEach(box => {
                if (typeof box.xPct === 'undefined') {
                    // æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›
                    box.xPct = (box.x / 1000) * 100;
                    box.yPct = (box.y / 600) * 100;
                }

                const el = document.createElement('div');
                el.className = 'control-box'; el.classList.add(box.shape || 'rectangle');
                el.dataset.boxId = box.id;
                const keycode = currentLayerData.boxes[box.id] || '';
                el.textContent = keycode || `BTN${box.id}`;

                // %é…ç½® (ä¸­å¿ƒåŸºæº– transform: translate(-50%, -50%) ãŒCSSã«ã‚ã‚‹å‰æ)
                el.style.left = box.xPct + '%';
                el.style.top = box.yPct + '%';

                // ã‚µã‚¤ã‚ºã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
                el.style.width = (box.width * responsiveScale) + 'px';
                el.style.height = (box.height * responsiveScale) + 'px';
                el.style.fontSize = (box.fontSize * responsiveScale) + 'px';
                el.style.fontFamily = box.fontFamily || "'Segoe UI', sans-serif";
                el.style.background = box.bgColor || '#ff8800';
                el.style.color = box.textColor || '#ffffff';
                el.style.borderColor = box.borderColor || '#ff8800';

                if (selectedBox === box.id) el.classList.add('selected');

                // --- ã‚¯ãƒªãƒƒã‚¯ãƒ»é¸æŠ ---
                el.onclick = (e) => { e.stopPropagation(); selectBox(box.id); };

                // --- ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« (é¸æŠä¸­ã®ã¿) ---
                if (selectedBox === box.id) {
                    const createHandle = (cursor, left, top, mode) => {
                        const h = document.createElement('div');
                        h.className = 'resize-handle';
                        h.style.cursor = cursor;
                        h.style.left = left;
                        h.style.top = top;
                        h.onpointerdown = (e) => {
                            e.stopPropagation(); e.preventDefault();
                            const startX = e.clientX; const startY = e.clientY;
                            const startW = box.width; const startH = box.height;
                            const startXPct = box.xPct; const startYPct = box.yPct;
                            const rect = img.getBoundingClientRect();

                            const move = (ev) => {
                                const dx = (ev.clientX - startX) / responsiveScale;
                                const dy = (ev.clientY - startY) / responsiveScale;

                                // %å¤‰æ›ç”¨ã®ãƒ”ã‚¯ã‚»ãƒ«å·®åˆ† (å®Ÿéš›ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã§ã®px)
                                const dxPx = ev.clientX - startX;
                                const dyPx = ev.clientY - startY;

                                if (mode.includes('e')) box.width = Math.max(20, startW + dx);
                                if (mode.includes('w')) {
                                    const nextW = Math.max(20, startW - dx);
                                    if (nextW > 20) {
                                        box.width = nextW;
                                        box.xPct = startXPct + (dxPx / rect.width) * 100;
                                    }
                                }
                                if (mode.includes('s')) box.height = Math.max(20, startH + dy);
                                if (mode.includes('n')) {
                                    const nextH = Math.max(20, startH - dy);
                                    if (nextH > 20) {
                                        box.height = nextH;
                                        box.yPct = startYPct + (dyPx / rect.height) * 100;
                                    }
                                }
                                renderControlBoxes();
                            };
                            const up = () => { document.removeEventListener('pointermove', move); document.removeEventListener('pointerup', up); };
                            document.addEventListener('pointermove', move); document.addEventListener('pointerup', up);
                        };
                        return h;
                    };
                    el.appendChild(createHandle('nwse-resize', '-12px', '-12px', 'nw'));
                    el.appendChild(createHandle('nesw-resize', 'calc(100% - 12px)', '-12px', 'ne'));
                    el.appendChild(createHandle('nesw-resize', '-12px', 'calc(100% - 12px)', 'sw'));
                    el.appendChild(createHandle('nwse-resize', 'calc(100% - 12px)', 'calc(100% - 12px)', 'se'));
                }

                // --- ãƒ‰ãƒ©ãƒƒã‚° & ã‚³ãƒ”ãƒ¼ & é•·æŠ¼ã— ---
                el.onpointerdown = (e) => {
                    e.stopPropagation();

                    let dragTarget = box;
                    const isCopyOp = (e.ctrlKey || e.metaKey);

                    if (isCopyOp) {
                        // ã‚³ãƒ”ãƒ¼ä½œæˆã—ã¦ã€æ–°ã—ã„æ–¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ã«ã™ã‚‹
                        dragTarget = JSON.parse(JSON.stringify(box));
                        dragTarget.id = nextBoxId++;
                        controlBoxes.push(dragTarget);
                        layers.forEach(l => { l.boxes[dragTarget.id] = l.boxes[box.id] || ''; });
                        selectBox(dragTarget.id);
                        // Note: ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚­ãƒ£ãƒ—ãƒãƒ£ã¯å…ƒã®è¦ç´ ã«ã‚ã‚‹ãŒã€moveå†…ã®dragTargetã‚’å·®ã—æ›¿ãˆãŸã®ã§
                        // å…ƒã®è¦ç´ ã‚’æ´ã‚“ã ã¾ã¾ã€ãƒ‡ãƒ¼ã‚¿ä¸Šã®æ–°ã—ã„ä½ç½®ã‚’æ›´æ–°ã™ã‚‹
                    } else {
                        e.target.setPointerCapture(e.pointerId);
                        // é•·æŠ¼ã—ã‚³ãƒ”ãƒ¼ã‚¿ã‚¤ãƒãƒ¼
                        longPressTimer = setTimeout(() => {
                            const newBox = JSON.parse(JSON.stringify(box));
                            newBox.id = nextBoxId++;
                            newBox.xPct += 5; newBox.yPct += 5;
                            controlBoxes.push(newBox);
                            layers.forEach(l => { l.boxes[newBox.id] = l.boxes[box.id] || ''; });
                            selectBox(newBox.id);
                            renderControlBoxes();
                        }, 1000);
                    }

                    const startX = e.clientX; const startY = e.clientY;
                    const startPctX = dragTarget.xPct; const startPctY = dragTarget.yPct;
                    const rect = img.getBoundingClientRect();

                    const move = (ev) => {
                        const dx = ev.clientX - startX; const dy = ev.clientY - startY;
                        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                            clearTimeout(longPressTimer);
                        }
                        dragTarget.xPct = startPctX + (dx / rect.width) * 100;
                        dragTarget.yPct = startPctY + (dy / rect.height) * 100;
                        renderControlBoxes();
                    };

                    const up = () => {
                        clearTimeout(longPressTimer);
                        if (!isCopyOp) e.target.releasePointerCapture(e.pointerId);
                        document.removeEventListener('pointermove', move);
                        document.removeEventListener('pointerup', up);
                    };

                    document.addEventListener('pointermove', move);
                    document.addEventListener('pointerup', up);
                };

                container.appendChild(el);
            });
        }

        // Resizeæ™‚ã®å†æç”»ï¼ˆ%æŒ‡å®šãªã‚‰CSSä»»ã›ã§è‰¯ã„ãŒã€pxè¨ˆç®—ã—ã¦ã„ã‚‹ã‚µã‚¤ã‚ºè£œæ­£ã®ãŸã‚ï¼‰
        window.addEventListener('resize', renderControlBoxes);


        // ==================== CLOUD FUNCTIONS (UPDATED) ====================
        async function cloudSave() {
            const slot = document.getElementById('cloudSlot').value;
            const data = {
                layers,
                controlBoxes, // xPctãªã©ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹
                // imageData: document.getElementById('controllerImage').src, // ãƒ‡ãƒ¼ã‚¿é‡å‰Šæ¸›ã®ãŸã‚å‰Šé™¤æ¤œè¨ã ãŒç¶­æŒ
                // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒå·¨å¤§ã™ãã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€ç¾çŠ¶ç¶­æŒ
                imageData: document.getElementById('controllerImage').src,
                nextBoxId,
                colorHistory
                // imageScaleã¯ä¿å­˜ã—ãªã„(ç«¯æœ«ã”ã¨ã®è¡¨ç¤ºè¨­å®šã¨ã™ã‚‹)
            };

            try {
                const res = await fetch(`/save?slot=${slot}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    alert(`Slot: ${slot}\nã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼`);
                } else {
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                    let errorMsg = `ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n`;
                    errorMsg += `ã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}\n`;
                    if (result.message) errorMsg += `è©³ç´°: ${result.message}\n`;
                    if (result.code) errorMsg += `ã‚³ãƒ¼ãƒ‰: ${result.code}\n`;
                    if (result.bucket) errorMsg += `ãƒã‚±ãƒƒãƒˆ: ${result.bucket}\n`;
                    if (result.hint) errorMsg += `\nğŸ’¡ ãƒ’ãƒ³ãƒˆ:\n${result.hint}`;

                    alert(errorMsg);
                    console.error('Save error details:', result);
                }
            } catch (e) {
                console.error('Save exception:', e);
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n${e.message}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        async function cloudLoad() {
            const slot = document.getElementById('cloudSlot').value;
            if (!confirm(`Slot: ${slot}\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const res = await fetch(`/load?slot=${slot}`);

                if (!res.ok) {
                    const errorData = await res.json();
                    let errorMsg = `èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n`;
                    errorMsg += `ã‚¨ãƒ©ãƒ¼: ${errorData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}\n`;
                    if (errorData.message) errorMsg += `è©³ç´°: ${errorData.message}\n`;
                    if (errorData.code) errorMsg += `ã‚³ãƒ¼ãƒ‰: ${errorData.code}\n`;
                    if (errorData.bucket) errorMsg += `ãƒã‚±ãƒƒãƒˆ: ${errorData.bucket}\n`;
                    if (errorData.hint) errorMsg += `\nğŸ’¡ ãƒ’ãƒ³ãƒˆ:\n${errorData.hint}`;

                    alert(errorMsg);
                    console.error('Load error details:', errorData);
                    return;
                }

                const data = await res.json();

                // ãƒ‡ãƒ¼ã‚¿é©ç”¨
                if (data.layers) layers = data.layers;
                if (data.controlBoxes) controlBoxes = data.controlBoxes;
                if (data.nextBoxId) nextBoxId = data.nextBoxId;
                if (data.colorHistory) colorHistory = data.colorHistory;
                if (data.imageData) {
                     const img = document.getElementById('controllerImage');
                     img.onload = () => {
                         // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å†æç”»ã—ãªã„ã¨ã‚µã‚¤ã‚ºè¨ˆç®—ç‹‚ã†
                         renderControlBoxes();
                     };
                     img.src = data.imageData;
                     img.style.display = 'block';
                }

                currentLayer = 0;
                renderLayerTabs();
                updateLayerBadge();
                renderControlBoxes();

                alert(`Slot: ${slot}\nèª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`);
            } catch (e) {
                console.error('Load exception:', e);
                alert(`èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${e.message}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        // ==================== IMAGE EXPORT ====================
        function exportAsImage() {
            // HTML5 Canvasã‚’ä½¿ã£ã¦ã€ç”»åƒã¨ç¾åœ¨ã®ãƒœã‚¿ãƒ³é…ç½®ã‚’åˆæˆã—ã¦å‡ºåŠ›ã™ã‚‹
            const img = document.getElementById('controllerImage');
            if (img.style.display === 'none') { alert('ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“'); return; }

            const canvas = document.createElement('canvas');
            // å…ƒç”»åƒã®è§£åƒåº¦ã§å‡ºåŠ›ã™ã‚‹
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');

            // 1. ç”»åƒã‚’æç”»
            ctx.drawImage(img, 0, 0);

            // 2. ãƒœã‚¿ãƒ³ã‚’æç”»
            const currentLayerData = layers[currentLayer];
            if (currentLayerData) {
                controlBoxes.forEach(box => {
                    // åº§æ¨™å¤‰æ› (% -> px)
                    // box.xPct ãŒç„¡ã‘ã‚Œã°æ—§ãƒ‡ãƒ¼ã‚¿(px)ã‚’å…ƒã«è¨ˆç®—
                    // ã“ã“ã§ã¯ renderControlBoxes ã¨åŒã˜ä»®å®šãŒå¿…è¦ã ãŒã€
                    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã¯ã€Œå…ƒç”»åƒã‚µã‚¤ã‚ºã€ã«å¯¾ã™ã‚‹ä½ç½®ãŒå¿…è¦

                    let x, y, w, h;

                    if (typeof box.xPct !== 'undefined') {
                        x = (box.xPct / 100) * canvas.width;
                        y = (box.yPct / 100) * canvas.height;
                    } else {
                        // æ—§äº’æ›: 1000pxåŸºæº–ã¨ã¿ãªã™
                        x = (box.x / 1000) * canvas.width;
                        y = (box.y / 600) * canvas.height;
                    }

                    // ã‚µã‚¤ã‚ºè¨ˆç®—: åŸºæº–å¹…1000pxã«å¯¾ã™ã‚‹æ¯”ç‡ã§è¨ˆç®—
                    // box.width(px at 1000px width)
                    const scale = canvas.width / 1000;
                    w = box.width * scale;
                    h = box.height * scale;
                    const fontSize = box.fontSize * scale;

                    // èƒŒæ™¯
                    ctx.fillStyle = box.bgColor;
                    ctx.strokeStyle = box.borderColor;
                    ctx.lineWidth = 2 * scale;

                    if (box.shape === 'circle') {
                        ctx.beginPath();
                        ctx.arc(x + w/2, y + h/2, Math.max(w,h)/2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                    } else {
                        // rectangle
                        ctx.fillRect(x, y, w, h);
                        ctx.strokeRect(x, y, w, h);
                    }

                    // æ–‡å­—
                    ctx.fillStyle = box.textColor;
                    ctx.font = `${fontSize}px ${box.fontFamily.replace(/'/g, "")}`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const text = currentLayerData.boxes[box.id] || `BTN${box.id}`;
                    ctx.fillText(text, x + w/2, y + h/2);
                });
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            link.download = `layout_export.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // ==================== GLOBAL STATE (continued) ====================

        let layers = [];
        let currentLayer = 0;
        let controlBoxes = [];
        let selectedBox = null;
        let nextBoxId = 1;
        let imageScale = 1.0;
        let isDragging = false;
        let isCopying = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragBoxStartX = 0;
        let dragBoxStartY = 0;
        let colorHistory = [];
        const MAX_COLORS = 12;
        let longPressTimer = null;
        let startDistance = 0;

        // ==================== ID MANAGEMENT ====================
        function refreshNextBoxId(savedNextId) {
             if (controlBoxes.length > 0) {
                 const maxId = Math.max(...controlBoxes.map(b => b.id));
                 nextBoxId = Math.max(savedNextId || 0, maxId + 1);
             } else {
                 nextBoxId = savedNextId || 1;
             }
        }

        // ==================== IMAGE HANDLING ====================
        function loadImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('controllerImage');
                img.src = e.target.result;
                img.style.display = 'block';
                // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å†æç”»
                img.onload = () => renderControlBoxes();

                if (layers.length === 0) {
                    layers.push({ name: 'Default', boxes: {} });
                    currentLayer = 0;
                    renderLayerTabs();
                    updateLayerBadge();
                }
            };
            reader.readAsDataURL(file);
        }

        async function loadLocalPngImages() {
             try {
                 const pngFiles = ['controller1.png', 'controller2.png', 'buttonbox.png', 'wheel.png', 'gtneo.png', 'pxn_cb1.png'];
                 const imageSelect = document.getElementById('imageSelect');
                 imageSelect.innerHTML = '<div style="width: 100%; color: #aaa; font-size: 0.9em;">åŒã˜éšå±¤ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«:</div>';
                 for (const filename of pngFiles) {
                     const img = new Image();
                     img.src = filename;
                     img.onload = () => {
                         const btn = document.createElement('div');
                         btn.className = 'image-option'; btn.textContent = filename;
                         btn.onclick = () => loadImageFromPath(filename);
                         imageSelect.appendChild(btn);
                         imageSelect.style.display = 'flex';
                     };
                 }
             } catch (err) {}
        }

        function loadImageFromPath(path) {
            const img = document.getElementById('controllerImage');
            img.src = path;
            img.style.display = 'block';
            img.onload = () => renderControlBoxes();

            if (layers.length === 0) {
                layers.push({ name: 'Default', boxes: {} });
                currentLayer = 0;
                renderLayerTabs();
                updateLayerBadge();
            }
        }

        function zoomIn() { imageScale = Math.min(imageScale + 0.1, 3.0); updateImageScale(); }
        function zoomOut() { imageScale = Math.max(imageScale - 0.1, 0.3); updateImageScale(); }
        function updateImageScale() {
             const img = document.getElementById('controllerImage');
             img.style.transform = `scale(${imageScale})`;
             document.getElementById('zoomLevel').textContent = Math.round(imageScale * 100) + '%';
             // renderControlBoxes(); // å¤‰æ›´: renderControlBoxesã¯scaleã«ä¾å­˜ã—ãªã„(pxä½ç½®è¨ˆç®—ã®ã¿scaleä¾å­˜ã ã£ãŸãŒã€%åŒ–ã§ä¸è¦ï¼Ÿ ã„ã‚„ã€scaleã¯transformãªã®ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã¯å¤‰ãˆãªã„)
        }

        // ==================== SELECTION & UPDATE ====================
        function deleteSelectedBox() {
            if (selectedBox === null) return;
            controlBoxes = controlBoxes.filter(box => box.id !== selectedBox);
            layers.forEach(layer => { delete layer.boxes[selectedBox]; });
            selectedBox = null;
            document.getElementById('editorPanel').classList.remove('visible');
            renderControlBoxes();
        }

        function selectBox(boxId) {
            selectedBox = boxId;
            const box = controlBoxes.find(b => b.id === boxId);
            if (!box) return;

            const keycode = layers[currentLayer]?.boxes[boxId] || '';
            document.getElementById('selectedBoxId').textContent = `(Button ${boxId})`;
            document.getElementById('keycodeInput').value = keycode;

            // %åº§æ¨™ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã‚ã‹ã‚Šã«ãã„ã®ã§ã€å¾“æ¥é€šã‚Šã€Œç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«ã§ã®pxã€ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯%ã‚’è¡¨ç¤ºã™ã‚‹ã‹
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯pxã§å¾®èª¿æ•´ã—ãŸã„ã‹ã‚‚ã€‚
            // æš«å®š: å…¥åŠ›æ¬„ã¯pxã®ã¾ã¾æ“ä½œã•ã›ã‚‹ï¼ˆupdateæ™‚ã«%ã«å†å¤‰æ›ï¼‰
            // ãã®ãŸã‚ã«ç¾åœ¨ã®ç”»åƒã®ã‚µã‚¤ã‚ºã‚’å–å¾—
             const img = document.getElementById('controllerImage');
             const rect = img.getBoundingClientRect(); // scaled size
             // wait, width is clientWidth
             const w = img.clientWidth;
             const h = img.clientHeight;

             // è¡¨ç¤ºç”¨px
             const pxX = Math.round((box.xPct / 100) * w);
             const pxY = Math.round((box.yPct / 100) * h);
             // Width/Height is tricky because we store raw px (relative to 1000) or we want to store %.
             // In addControlBox we saved `width: 80`. Render logic uses `box.width * scale`.
             // So just show box.width.
            document.getElementById('boxX').value = pxX;
            document.getElementById('boxY').value = pxY;
            document.getElementById('boxWidth').value = box.width;
            document.getElementById('boxHeight').value = box.height;

            document.getElementById('boxFontSize').value = box.fontSize;
            document.getElementById('boxShape').value = box.shape || 'rectangle';
            document.getElementById('boxFont').value = box.fontFamily || "'Segoe UI', sans-serif";

            // ã‚«ãƒ©ãƒ¼è¨­å®š
            document.getElementById('boxBgColor').value = box.bgColor || '#ff8800';
            document.getElementById('boxBgColorText').value = box.bgColor || '#ff8800';
            document.getElementById('boxTextColor').value = box.textColor || '#ffffff';
            document.getElementById('boxTextColorText').value = box.textColor || '#ffffff';
            document.getElementById('boxBorderColor').value = box.borderColor || '#ff8800';
            document.getElementById('boxBorderColorText').value = box.borderColor || '#ff8800';
            document.getElementById('editorPanel').classList.add('visible');
            renderControlBoxes();
        }

        function updateKeycode(value) {
            if (selectedBox === null || !layers[currentLayer]) return;
            layers[currentLayer].boxes[selectedBox] = value;
            renderControlBoxes();
        }
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        document.addEventListener('keydown', (e) => {
            if (selectedBox === null || e.target.tagName === 'INPUT') return;
            const box = controlBoxes.find(b => b.id === selectedBox);
            if (!box) return;

            const img = document.getElementById('controllerImage');
            const rect = img.getBoundingClientRect();
            // 1pxç›¸å½“ã®%è¨ˆç®—
            const stepXPct = (1 / rect.width) * 100;
            const stepYPct = (1 / rect.height) * 100;

            if (e.key === 'Delete') {
                deleteSelectedBox();
                return;
            }

            if (e.shiftKey) {
                if (e.key === 'ArrowRight') box.width += 1;
                else if (e.key === 'ArrowLeft') box.width = Math.max(10, box.width - 1);
                else if (e.key === 'ArrowDown') box.height += 1;
                else if (e.key === 'ArrowUp') box.height = Math.max(10, box.height - 1);
                else return;
            } else {
                if (e.key === 'ArrowRight') box.xPct += stepXPct;
                else if (e.key === 'ArrowLeft') box.xPct -= stepXPct;
                else if (e.key === 'ArrowDown') box.yPct += stepYPct;
                else if (e.key === 'ArrowUp') box.yPct -= stepYPct;
                else return;
            }
            if (!e.target.closest('#colorPalette')) { e.preventDefault(); }
            renderControlBoxes();
        });

        function updateBoxPosition() {
             if (selectedBox === null) return;
             const box = controlBoxes.find(b => b.id === selectedBox);
             if (!box) return;
             // å…¥åŠ›ã•ã‚ŒãŸpxå€¤ã‚’%ã«å¤‰æ›ã—ã¦ä¿å­˜
             const inputX = parseInt(document.getElementById('boxX').value) || 0;
             const inputY = parseInt(document.getElementById('boxY').value) || 0;
             const img = document.getElementById('controllerImage');
             if(img.clientWidth > 0) {
                 box.xPct = (inputX / img.clientWidth) * 100;
                 box.yPct = (inputY / img.clientHeight) * 100;
             }
             renderControlBoxes();
        }

        function updateBoxSize() {
             if (selectedBox === null) return;
             const box = controlBoxes.find(b => b.id === selectedBox);
             if (!box) return;
             box.width = parseInt(document.getElementById('boxWidth').value) || 60;
             box.height = parseInt(document.getElementById('boxHeight').value) || 40;
             renderControlBoxes();
        }

        function updateBoxStyle() {
             if (selectedBox === null) return;
             const box = controlBoxes.find(b => b.id === selectedBox);
             if (!box) return;
             box.fontSize = parseInt(document.getElementById('boxFontSize').value) || 14;
             box.shape = document.getElementById('boxShape').value;
             box.fontFamily = document.getElementById('boxFont').value;
             renderControlBoxes();
        }

        function updateBoxColor() {
            if (selectedBox === null) return;
            const box = controlBoxes.find(b => b.id === selectedBox);
            if (!box) return;
            box.bgColor = document.getElementById('boxBgColor').value;
            box.textColor = document.getElementById('boxTextColor').value;
            box.borderColor = document.getElementById('boxBorderColor').value;
            document.getElementById('boxBgColorText').value = box.bgColor;
            document.getElementById('boxTextColorText').value = box.textColor;
            document.getElementById('boxBorderColorText').value = box.borderColor;
            addToColorHistory(box.bgColor); addToColorHistory(box.textColor); addToColorHistory(box.borderColor);
            renderControlBoxes();
        }

        function updateBoxColorFromText(type) {
            if (selectedBox === null) return;
            const box = controlBoxes.find(b => b.id === selectedBox);
            if (!box) return;
            const textValue = document.getElementById(`box${type.charAt(0).toUpperCase() + type.slice(1)}ColorText`).value;
            document.getElementById(`box${type.charAt(0).toUpperCase() + type.slice(1)}Color`).value = textValue;
            if (type === 'bg') box.bgColor = textValue;
            else if (type === 'text') box.textColor = textValue;
            else if (type === 'border') box.borderColor = textValue;
            renderControlBoxes();
        }

        function addToColorHistory(color) {
            if (!color) return;
            colorHistory = colorHistory.filter(c => c !== color);
            colorHistory.unshift(color);
            if (colorHistory.length > MAX_COLORS) colorHistory = colorHistory.slice(0, MAX_COLORS);
            renderColorPalette();
        }

        function renderColorPalette() {
            const palettes = ['bgColorPalette', 'textColorPalette', 'borderColorPalette'];
            palettes.forEach(paletteId => {
                const palette = document.getElementById(paletteId);
                if (!palette) return;
                palette.innerHTML = '';
                colorHistory.forEach(color => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'palette-color'; colorDiv.style.background = color; colorDiv.title = color;
                    colorDiv.onclick = () => {
                        const type = paletteId.replace('ColorPalette', '');
                        applyPaletteColor(type, color);
                    };
                    palette.appendChild(colorDiv);
                });
                const addBtn = document.createElement('div');
                addBtn.className = 'palette-add'; addBtn.textContent = '+'; addBtn.title = 'ç¾åœ¨ã®è‰²ã‚’ä¿å­˜';
                addBtn.onclick = () => {
                   const type = paletteId.replace('ColorPalette', '');
                   const currentColor = document.getElementById(`box${type.charAt(0).toUpperCase() + type.slice(1)}Color`).value;
                   addToColorHistory(currentColor);
                };
                palette.appendChild(addBtn);
            });
        }

        function applyPaletteColor(type, color) {
            const cap = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById(`box${cap}Color`).value = color;
            document.getElementById(`box${cap}ColorText`).value = color;
            updateBoxColor();
        }

        // ==================== LAYER & TABS ====================
        function renderLayerTabs() {
            const tabs = document.getElementById('layerTabs');
            tabs.innerHTML = ''; // Clear existing tabs

            layers.forEach((layer, index) => {
                const tab = document.createElement('div');
                tab.className = `layer-tab ${index === currentLayer ? 'active' : ''}`;
                tab.onclick = () => switchLayer(index);

                const nameSpan = document.createElement('span');
                nameSpan.className = 'layer-name';
                nameSpan.textContent = layer.name;
                nameSpan.setAttribute('contenteditable', 'true');
                nameSpan.onblur = (e) => { layer.name = e.target.textContent || `LAYER ${index}`; };
                nameSpan.onclick = (e) => e.stopPropagation(); // é¸æŠé˜²æ­¢

                const delBtn = document.createElement('div');
                delBtn.className = 'delete-layer';
                delBtn.innerHTML = 'Ã—';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteLayer(index); };

                tab.appendChild(nameSpan);
                if (layers.length > 1) { // Only show delete button if there's more than one layer
                    tab.appendChild(delBtn);
                }
                tabs.appendChild(tab);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'add-layer-btn'; addBtn.textContent = '+ ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ '; addBtn.onclick = addLayer;
            tabs.appendChild(addBtn);

            document.getElementById('layerCount').textContent = layers.length;
        }

        function switchLayer(index) {
             currentLayer = index; renderLayerTabs(); renderControlBoxes(); updateLayerBadge();
             if (selectedBox !== null) selectBox(selectedBox);
        }
        function addLayer() {
             const name = prompt('ãƒ¬ã‚¤ãƒ¤ãƒ¼å:', `Layer${layers.length + 1}`);
             if (name) {
                 const newL = { name, boxes: {} };
                 controlBoxes.forEach(b => { newL.boxes[b.id] = ''; });
                 layers.push(newL); switchLayer(layers.length - 1);
             }
        }
        function deleteLayer(index) {
             if (layers.length <= 1) return;
             if (confirm(`"${layers[index].name}" ã‚’å‰Šé™¤ï¼Ÿ`)) {
                 layers.splice(index, 1);
                 currentLayer = Math.min(currentLayer, layers.length - 1);
                 renderLayerTabs(); renderControlBoxes(); updateLayerBadge();
             }
        }
        function updateLayerBadge() { document.getElementById('layerCount').textContent = layers.length; }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã¯çµ±åˆã®ãŸã‚å‰Šé™¤
        function showCategory(cat) {
            document.querySelectorAll('.keycode-quick').forEach(el => el.classList.remove('visible'));
            document.querySelectorAll('.category-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(cat + 'Keycodes').classList.add('visible');
            event.target.classList.add('active');
        }
        document.querySelectorAll('.keycode-quick').forEach(c => {
            c.addEventListener('click', (e) => {
                if (e.target.classList.contains('keycode-btn')) {
                    const kc = e.target.dataset.kc;
                    document.getElementById('keycodeInput').value = kc; updateKeycode(kc);
                }
            });
        });
        function switchTab(t) {
            ['save', 'export'].forEach(id => {
                document.getElementById(id + 'Tab').classList.toggle('active', id === t);
                document.querySelector(`[onclick="switchTab('${id}')"]`).classList.toggle('active', id === t);
            });
        }

        function applyData(data) {
             layers = data.layers || [];
             controlBoxes = data.controlBoxes || [];
             imageScale = data.imageScale || 1.0; // zoom only
             refreshNextBoxId(data.nextBoxId);
             colorHistory = data.colorHistory || [];
             const img = document.getElementById('controllerImage');
             if (data.imageData) { img.src = data.imageData; img.style.display = 'block'; }
             updateImageScale(); renderLayerTabs(); renderControlBoxes(); updateLayerBadge(); renderColorPalette();
        }

        function clearAll() {
             if (confirm('å…¨ã‚¯ãƒªã‚¢ï¼Ÿ')) {
                 layers = []; controlBoxes = []; selectedBox = null; currentLayer = 0; nextBoxId = 1;
                 document.getElementById('controllerImage').style.display = 'none';
                 renderLayerTabs(); renderControlBoxes(); updateLayerBadge();
             }
        }

        // ==================== EXPORT HELPERS ====================
        function exportJSON() {
            const slot = document.getElementById('cloudSlot').value;
            const data = { layers, controlBoxes, imageData: document.getElementById('controllerImage').src, imageScale, nextBoxId };
            downloadBlob(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }), `racing-keymap-${slot}.json`);
        }

        function downloadBlob(blob, name) {
            const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
        }

        renderLayerTabs(); updateLayerBadge(); loadLocalPngImages(); renderColorPalette();

        document.getElementById('layoutContainer').addEventListener('pointerdown', (e) => {
             if (e.target.closest('.control-box')) return;
             selectedBox = null;
             document.getElementById('editorPanel').classList.remove('visible');
             renderControlBoxes();
        });
  </script>
</body>
</html>
